#
# Using Conda within ENTRYPOINT was taken from:
# https://pythonspeed.com/articles/activate-conda-dockerfile/
#
# This Dockerfile will create a base image containing all the Conda and Pip
# requirements for SwotRepr.
#
# This Dockerfile does not copy the PyMods or the test directory, these will
# be copied when the image is run as a container, to allow more rapid
# development iteration.
#

FROM continuumio/miniconda3

ARG EDL_USERNAME
ARG EDL_PASSWORD

WORKDIR "/home"

# Bundle app source
# COPY ./PyMods Pymods
# COPY swotrepr.py .
COPY conda_requirements.txt .
COPY pip_requirements.txt .
COPY test/pip_test_requirements.txt .

# Create Conda environment
# --channel conda-forge
RUN conda create --name swotrepr --file conda_requirements.txt python=3.7 \
	--channel conda-forge \
	--channel defaults

# Make RUN commands use the Conda environment
SHELL ["conda", "run", "--name", "swotrepr", "/bin/bash", "-c"]

# Install additional Pip dependencies
RUN pip install -r pip_requirements.txt

# Install additional Pip requirements (for testing)
RUN pip install -r pip_test_requirements.txt

# Install Harmony
# Note GIT credentials could have issue if password contains certain characters.
# URL encoding additional characters besides '@' may be required
RUN pip install "git+https://${EDL_USERNAME}:${EDL_PASSWORD}@git.earthdata.nasa.gov/scm/harmony/harmony-service-lib-py.git"
